@{
    ViewBag.Title = "警報群組設定";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section css{
    <link rel="stylesheet" href="@Url.Content("~/Scripts/base/easyui/themes/bootstrap/easyui.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/base/easyui/themes/icon.css")" />
}

<div class="easyui-layout" style="width:100%; height:98%">
    <!-- 左邊：警報群組列表 -->
    <div data-options="region:'west',split:true" title="警報群組列表" style="width:500px;padding:5px">
        <table id="groupGrid" class="easyui-datagrid" style="width:100%"
               data-options="
             url:'@Url.Action("GetAlertGroups","AlarmManage")',
             method:'get',
             singleSelect:true,
             onSelect: onGroupSelect,
             toolbar:'#groupToolbar',
             fitColumns:true">
            <thead>
                <tr>
                    <th data-options="field:'GroupName',title:'群組名稱',width:120"></th>
                    <th data-options="field:'Description',title:'描述',width:150"></th>
                    <th data-options="field:'IsActive',title:'是否發報',width:60,align:'center',formatter:formatActiveStatus"></th>
                </tr>
            </thead>
        </table>
        <div id="groupToolbar" style="display:flex; align-items:center; gap:5px;">
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="openGroupDlg()">新增</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="editGroup()">編輯</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="deleteGroup()">刪除</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="toggleGroupActive()">啟用/停用</a>
        </div>
    </div>

    <!-- 右邊：分區顯示機台群組管理 -->
    <div data-options="region:'center'" style="padding:0px">
        <div class="easyui-layout" style="width:100%;height:100%">
            <!-- 機台群組管理 -->
            <div data-options="region:'center',title:'機台群組管理'" style="padding:5px">
                <table id="machineGroupGrid" class="easyui-datagrid" style="width:100%"
                       data-options="
                         url:'@Url.Action("GetMachineGroups","AlarmManage")',
                         method:'get',
                         singleSelect:true,
                         onSelect:onMGSelect,
                         toolbar:'#mgToolbar',
                         fitColumns:true">
                    <thead>
                        <tr>
                            <th data-options="field:'MachineGroupId',hidden:true"></th>
                            <th data-options="field:'GroupName',title:'群組名稱',width:150"></th>
                            <th data-options="field:'Description',title:'描述',width:150"></th>
                        </tr>
                    </thead>
                </table>
                <div id="mgToolbar" style="display:flex; gap:5px">
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="openMGDlg()">新增</a>
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="editMG()">編輯</a>
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="deleteMG()">刪除</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialog：新增／編輯 警報群組 -->
<div id="dlgGroup" class="easyui-dialog" closed="true" modal="true" buttons="#dlgGroupBtns"
     style="width:600px;height:550px;padding:10px">
    <form id="formGroup" method="post" style="margin-bottom:10px">
        <input name="AlertGroupId" type="hidden" />
        <div style="margin-bottom:8px;">
            <label>群組名稱：</label>
            <input name="GroupName" class="easyui-textbox" required="true" style="width:480px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>描述：</label>
            <input name="Description" class="easyui-textbox" style="width:480px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>選擇角色：</label>
            <select id="roleSelect" class="easyui-combobox" style="width:480px"
                    data-options="
                      url:'@Url.Action("GetRoles","AlarmManage")',
                      method:'get',
                      valueField:'RoleId',
                      textField:'RoleName',
                      panelHeight:'200',
                      editable:false
                    ">
            </select>
        </div>
        <div style="margin-bottom:10px;">
            <label>是否啟用發報：</label>
            <input type="checkbox" name="IsActive" id="IsActive" checked /> 啟用
        </div>
    </form>

    <h4>選擇機台群組（勾選即屬於此警報群組）</h4>
    <table id="alertMachineGroupGrid" class="easyui-datagrid" style="width:100%;height:250px"
           data-options="singleSelect:false,checkbox:true,fitColumns:true">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'MachineGroupId',hidden:true"></th>
                <th data-options="field:'GroupName',title:'群組名稱',width:150"></th>
                <th data-options="field:'Description',title:'描述',width:200"></th>
            </tr>
        </thead>
    </table>
</div>
<div id="dlgGroupBtns" style="text-align:center;padding:5px; display:flex; justify-content:end;">
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="saveGroup()">儲存</a>
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="$('#dlgGroup').dialog('close')">取消</a>
</div>

<!-- Dialog：新增／編輯 機台群組 -->
<div id="dlgMG" class="easyui-dialog" closed="true" modal="true" buttons="#dlgMGBtns"
     style="height:80% ;width:600px;padding:10px">
    <form id="formMG" method="post" style="margin-bottom:10px">
        <input name="GroupId" type="hidden" />
        <div style="margin-bottom:8px;">
            <label>群組名稱：</label>
            <input name="GroupName" class="easyui-textbox" required="true" style="width:400px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>描述：</label>
            <input name="Description" class="easyui-textbox" style="width:400px" />
        </div>
    </form>

    <h4>選擇機台群組的機台（勾選即屬於此機台群組）</h4>
    <table id="machineSelectGrid" class="easyui-datagrid" style="width:100%;height:300px"
           data-options="singleSelect:false,checkbox:true,fitColumns:true">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'DeviceId',title:'機台編號',width:100"></th>
                <th data-options="field:'DeviceName',title:'機台名稱',width:200"></th>
            </tr>
        </thead>
    </table>
</div>
<div id="dlgMGBtns" style="text-align:center;padding:5px; display:flex; justify-content:end;">
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="saveMG()">儲存</a>
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="$('#dlgMG').dialog('close')">取消</a>
</div>

@section Scripts{
    <script src="~/Scripts/base/easyui/jquery.easyui.min.js"></script>
    <script>
        let currentMGId = null;
        let currentGroupName = null;
        let currentGroupId = null;  // 新增這個變數

        $(function(){
            initAlertGroupGrid();
            initMachineGroupGrid();
            initMGDialog();
            initAlertGroupDialog();
        });

        // 格式化 IsActive 狀態顯示
        function formatActiveStatus(value, row, index) {
            if (value) {
                return '<span style="color:green;"><i class="fa fa-check"></i> 啟用</span>';
            } else {
                return '<span style="color:red;"><i class="fa fa-times"></i> 停用</span>';
            }
        }

        // === 警報群組相關功能 ===
        function initAlertGroupGrid(){
            $('#groupGrid').datagrid({
                url: '@Url.Action("GetAlertGroups","AlarmManage")',
                method: 'get',
                singleSelect: true,
                fitColumns: true,
                onSelect: onGroupSelect,
                onDblClickRow: function(index,row){
                    $('#groupGrid').datagrid('selectRow', index);
                    editGroup();
                }
            });
        }

        // 初始化警報群組對話框的機台群組選擇表格
        function initAlertGroupDialog(){
            $('#alertMachineGroupGrid').datagrid({
                singleSelect: false,
                checkbox: true,
                fitColumns: true
            });
        }

        function onGroupSelect(index, row){
            currentGroupId = row.AlertGroupId;  // 改用 AlertGroupId
            currentGroupName = row.GroupName;   // 保留名稱用於顯示
            console.log('選擇警報群組:', currentGroupId, currentGroupName);
        }

        function openGroupDlg(){
            currentGroupName = null;
            $('#formGroup').form('clear');
            $('#roleSelect').combobox('clear');
            $('#IsActive').prop('checked', true);
            $('#dlgGroup').dialog('open').dialog('setTitle','新增警報群組');
            loadMachineGroupsForAlert([]);
        }

        function editGroup(){
            const row = $('#groupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');

            currentGroupId = row.AlertGroupId;  // 改用 AlertGroupId
            currentGroupName = row.GroupName;
            $('#formGroup').form('load', row);
            $('#dlgGroup').dialog('open').dialog('setTitle', '編輯警報群組');

            // 載入該警報群組的設定
            $.get('@Url.Action("GetAlertGroupDetail","AlarmManage")', { alertGroupId: row.AlertGroupId }, res => {
                if(res.success){
                    // 設定角色（多選）
                    if(res.data.RoleIds && res.data.RoleIds.length > 0){
                        $('#roleSelect').combobox('setValues', res.data.RoleIds);
                    }
                    // 設定 IsActive
                    $('#IsActive').prop('checked', !!res.data.IsActive);

                    // 載入機台群組並選中已選的機台群組
                    if(res.data.MachineGroupIds && res.data.MachineGroupIds.length > 0){
                        loadMachineGroupsForAlert(res.data.MachineGroupIds);
                    } else {
                        loadMachineGroupsForAlert([]);
                    }
                }
            });
        }

        // 為警報群組載入機台群組清單
        function loadMachineGroupsForAlert(selectedGroupIds){
            $.get('@Url.Action("GetMachineGroups","AlarmManage")', res => {
                console.log('載入機台群組:', res);
                // GetMachineGroups 回傳格式: { total: X, rows: [...] }
                if(res && res.rows){
                    $('#alertMachineGroupGrid').datagrid('loadData', res.rows);

                    res.rows.forEach((r,i)=>{
                        if(selectedGroupIds.includes(r.MachineGroupId)){
                            $('#alertMachineGroupGrid').datagrid('checkRow', i);
                        }
                    });
                } else {
                    console.error('無法載入機台群組清單');
                }
            });
        }

        function saveGroup(){
            const roleId = $('#roleSelect').combobox('getValue');
            const selectedMachineGroups = $('#alertMachineGroupGrid').datagrid('getChecked').map(r => r.MachineGroupId);
            const formData = $('#formGroup').serializeArray();
            const data = {};

            formData.forEach(f => data[f.name] = f.value);
            data.RoleIds = roleId ? [parseInt(roleId)] : [];
            data.IsActive = $('#IsActive').is(':checked');
            data.MachineGroupIds = selectedMachineGroups;

            // 新增時 AlertGroupId = 0，編輯時使用現有的 ID
            data.AlertGroupId = currentGroupId || 0;

            if(!roleId) {
                return $.messager.alert('提示','請選擇一個角色');
            }
            if(selectedMachineGroups.length === 0) {
                return $.messager.alert('提示','請至少選擇一個機台群組');
            }

            console.log('送出警報群組資料:', data);

                $.ajax({
                url: '@Url.Action("SaveGroup","AlarmManage")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: res => {
                    if(res.success){
                        $('#dlgGroup').dialog('close');
                        $('#groupGrid').datagrid('reload');
                    } else {
                        $.messager.alert('錯誤', res.message || '儲存失敗');
                    }
                }
            });
        }

        // 切換啟用/停用狀態
function toggleGroupActive(){
    const row = $('#groupGrid').datagrid('getSelected');
    if(!row) return $.messager.alert('提示','請先選擇一筆警報群組');

    const newStatus = !row.IsActive;
    const statusText = newStatus ? '啟用' : '停用';

    $.messager.confirm('確認', `確定要${statusText}「${row.GroupName}」警報群組？`, function(r){
        if(r){
            $.ajax({
                url: '@Url.Action("ToggleGroupActive","AlarmManage")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    AlertGroupId: row.AlertGroupId,  // 改用 AlertGroupId
                    IsActive: newStatus
                }),
                success: res => {
                    if(res.success){
                        $('#groupGrid').datagrid('reload');
                        $.messager.show({
                            title:'成功',
                            msg:`警報群組已${statusText}`
                        });
                    } else {
                        $.messager.alert('錯誤', res.message || '操作失敗');
                    }
                }
            });
        }
    });
}

        function deleteGroup(){
            const row = $('#groupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');

            $.messager.confirm('確認','確定刪除這個警報群組？', ok => {
                if(!ok) return;
                $.post('@Url.Action("DeleteAlertGroup","AlarmManage")',
                    { groupName: row.GroupName },
                    r => {
                        if(r.success){
                            $.messager.show({ title:'訊息', msg:'刪除成功' });
                            $('#groupGrid').datagrid('reload');
                        } else {
                            $.messager.alert('錯誤','刪除失敗');
                        }
                    },
                    'json'
                );
            });
        }

        // === 機台群組相關功能（保持不變）===
        function initMachineGroupGrid(){
            $('#machineGroupGrid').datagrid({
                url: '@Url.Action("GetMachineGroups","AlarmManage")',
                method: 'get',
                singleSelect: true,
                fitColumns: true,
                onSelect: onMGSelect,
                onDblClickRow: function(index,row){
                    $('#machineGroupGrid').datagrid('selectRow', index);
                    editMG();
                }
            });
        }

        function initMGDialog(){
            $('#machineSelectGrid').datagrid({
                singleSelect: false,
                checkbox: true,
                fitColumns: true
            });
        }

        function onMGSelect(index, row){
            currentMGId = row.MachineGroupId;
            console.log('選擇機台群組:', currentMGId);
        }

        function openMGDlg(){
            currentMGId = null;
            $('#formMG').form('clear');
            $('#dlgMG').dialog('open').dialog('setTitle','新增機台群組');
            loadMachinesForMG([]);
        }

        function editMG(){
            const row = $('#machineGroupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');
            currentMGId = row.MachineGroupId;

            $('#formMG').form('load', row);
            $('#dlgMG').dialog('open').dialog('setTitle','編輯機台群組');

            $.get('@Url.Action("GetMachineGroupsById", "AlarmManage")', { id: currentMGId }, res => {
                if(res.success){
                    const memberIds = res.data;
                    loadMachinesForMG(memberIds);
                }
            });
        }

        // 為機台群組載入機台清單
        function loadMachinesForMG(memberIds){
            $.get('@Url.Action("GetMachineList","MachineManage")', res => {
                const data = res.data.map(r=>({
                    DeviceId: r.DeviceID,
                    DeviceName: r.DeviceName
                }));
                $('#machineSelectGrid').datagrid('loadData', data);

                data.forEach((r,i)=>{
                    if(memberIds.includes(r.DeviceId)){
                        $('#machineSelectGrid').datagrid('checkRow', i);
                    }
                });
            });
        }

        function saveMG(){
            const name = $('#formMG input[name=GroupName]').val();
            const desc = $('#formMG input[name=Description]').val();
            const devs = $('#machineSelectGrid').datagrid('getChecked').map(r => r.DeviceId);

            if(!name) return $.messager.alert('提示','請輸入群組名稱');

            $.ajax({
                url: '@Url.Action("SaveMachineGroup", "AlarmManage")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    MachineGroupId: currentMGId || 0,
                    AlertGroupId: alertGroupId,
                    GroupName: name,
                    Description: desc,
                    Devices: devs
                }),
                success: res => {
                    if(res.success){
                        $('#dlgMG').dialog('close');
                        $('#machineGroupGrid').datagrid('reload');
                    } else {
                        $.messager.alert('錯誤','儲存失敗');
                    }
                }
            });
        }

        function deleteGroup(){
    const row = $('#groupGrid').datagrid('getSelected');
    if(!row) return $.messager.alert('提示','請先選擇一筆');

    $.messager.confirm('確認','確定刪除這個警報群組？', ok => {
        if(!ok) return;
        $.post('@Url.Action("DeleteAlertGroup","AlarmManage")',
            { alertGroupId: row.AlertGroupId },  // 改用 AlertGroupId
            r => {
                if(r.success){
                    $.messager.show({ title:'訊息', msg:'刪除成功' });
                    $('#groupGrid').datagrid('reload');
                } else {
                    $.messager.alert('錯誤','刪除失敗');
                }
            },
            'json'
        );
    });
}
    </script>
}