@{
    ViewBag.Title = "警報群組設定";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section css{
    <link rel="stylesheet" href="@Url.Content("~/Scripts/base/easyui/themes/bootstrap/easyui.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/base/easyui/themes/icon.css")" />
}

<div class="easyui-layout" style="width:100%; height:98%">
    <!-- 左邊：警報群組列表 -->
    <div data-options="region:'west',split:true" title="警報群組列表" style="width:60%;padding:5px">
        <table id="groupGrid" class="easyui-datagrid" style="width:100%"
               data-options="
             url:'@Url.Action("GetAlertGroups","AlarmManage")',
             method:'get',
             singleSelect:true,
             onSelect: onGroupSelect,
             toolbar:'#groupToolbar',
             fitColumns:true">
            <thead>
                <tr>
                    <th data-options="field:'RowNumber',title:'序號',width:40,align:'center'">序號</th>
                    <th data-options="field:'GroupName',title:'警報群組名稱',width:120">警報群組名稱</th>
                    <th data-options="field:'RoleName',title:'權限角色',width:100">權限角色</th>
                    <th data-options="field:'MachineGroupDisplay',title:'機台群組',width:200">機台群組</th>
                    <th data-options="field:'Description',title:'描述',width:120">描述</th>
                    <th data-options="field:'IsActive',title:'是否發報',width:80,align:'center',formatter:formatActiveStatus">是否發報</th>
                </tr>
            </thead>
        </table>
        <div id="groupToolbar" style="display:flex; align-items:center; gap:5px;">
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="openGroupDlg()">新增</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="editGroup()">編輯</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="deleteGroup()">刪除</a>
            <a href="javascript:void(0)" class="custom-easyui-button" onclick="toggleGroupActive()">啟用/停用</a>
        </div>
    </div>

    <!-- 右邊：機台群組管理 -->
    <div data-options="region:'center'" style="padding:0px">
        <div class="easyui-layout" style="width:100%;height:100%">
            <div data-options="region:'center',title:'機台群組管理'" style="padding:5px">
                <table id="machineGroupGrid" class="easyui-datagrid" style="width:100%"
                       data-options="
                         url:'@Url.Action("GetMachineGroups","AlarmManage")',
                         method:'get',
                         singleSelect:true,
                         onSelect:onMGSelect,
                         toolbar:'#mgToolbar',
                         fitColumns:true">
                    <thead>
                        <tr>
                            <th data-options="field:'MachineGroupId',hidden:true"></th>
                            <th data-options="field:'GroupName',title:'群組名稱',width:150">群組名稱</th>
                            <th data-options="field:'Description',title:'描述',width:150">描述</th>
                        </tr>
                    </thead>
                </table>
                <div id="mgToolbar" style="display:flex; gap:5px">
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="openMGDlg()">新增</a>
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="editMG()">編輯</a>
                    <a href="javascript:void(0)" class="custom-easyui-button" onclick="deleteMG()">刪除</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialog：新增／編輯 警報群組 -->
<div id="dlgGroup" class="easyui-dialog" closed="true" modal="true" buttons="#dlgGroupBtns"
     style="width:600px;height:550px;padding:10px">
    <form id="formGroup" method="post" style="margin-bottom:10px">
        <div style="margin-bottom:8px;">
            <label>群組名稱：</label>
            <input name="GroupName" id="GroupName" class="easyui-textbox" required="true" style="width:480px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>描述：</label>
            <input name="Description" id="Description" class="easyui-textbox" style="width:480px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>選擇角色：</label>
            <select id="roleSelect" class="easyui-combobox" style="width:480px"
                    data-options="
                      url:'@Url.Action("GetRoles","AlarmManage")',
                      method:'get',
                      valueField:'RoleId',
                      textField:'RoleName',
                      panelHeight:'200',
                      editable:false
                    ">
            </select>
        </div>
        <div style="margin-bottom:10px;">
            <label>是否啟用發報：</label>
            <input type="checkbox" name="IsActive" id="IsActive" checked /> 啟用
        </div>
    </form>

    <h4>選擇機台群組（可多選，一個角色對應多個機台群組）</h4>
    <table id="alertMachineGroupGrid" class="easyui-datagrid" style="width:100%;height:250px"
           data-options="singleSelect:false,checkbox:true,fitColumns:true">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'MachineGroupId',hidden:true"></th>
                <th data-options="field:'GroupName',title:'群組名稱',width:150"></th>
                <th data-options="field:'Description',title:'描述',width:200"></th>
            </tr>
        </thead>
    </table>
</div>
<div id="dlgGroupBtns" style="text-align:center;padding:5px; display:flex; justify-content:end;">
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="saveGroup()">儲存</a>
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="$('#dlgGroup').dialog('close')">取消</a>
</div>

<!-- Dialog：新增／編輯 機台群組 -->
<div id="dlgMG" class="easyui-dialog" closed="true" modal="true" buttons="#dlgMGBtns"
     style="height:80% ;width:600px;padding:10px">
    <form id="formMG" method="post" style="margin-bottom:10px">
        <input name="GroupId" type="hidden" />
        <div style="margin-bottom:8px;">
            <label>群組名稱：</label>
            <input name="GroupName" class="easyui-textbox" required="true" style="width:400px" />
        </div>
        <div style="margin-bottom:8px;">
            <label>描述：</label>
            <input name="Description" class="easyui-textbox" style="width:400px" />
        </div>
    </form>

    <h4>選擇機台群組的機台（勾選即屬於此機台群組）</h4>
    <table id="machineSelectGrid" class="easyui-datagrid" style="width:100%;height:300px"
           data-options="singleSelect:false,checkbox:true,fitColumns:true">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'DeviceId',title:'機台編號',width:100"></th>
                <th data-options="field:'DeviceName',title:'機台名稱',width:200"></th>
            </tr>
        </thead>
    </table>
</div>
<div id="dlgMGBtns" style="text-align:center;padding:5px; display:flex; justify-content:end;">
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="saveMG()">儲存</a>
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="$('#dlgMG').dialog('close')">取消</a>
</div>

@section Scripts{
    <script src="~/Scripts/base/easyui/jquery.easyui.min.js"></script>
    <script>
        let currentMGId = null;
        let currentGroupName = null;
        let currentRoleId = null;

        $(function(){
            initAlertGroupGrid();
            initMachineGroupGrid();
            initMGDialog();
            initAlertGroupDialog();
        });

        // 格式化 IsActive 狀態顯示
        function formatActiveStatus(value, row, index) {
            if (value) {
                return '<span style="color:green;"><i class="fa fa-check"></i> 啟用</span>';
            } else {
                return '<span style="color:red;"><i class="fa fa-times"></i> 停用</span>';
            }
        }

        // ===== 警報群組相關功能 =====
        function initAlertGroupGrid(){
            $('#groupGrid').datagrid({
                url: '@Url.Action("GetAlertGroups","AlarmManage")',
                method: 'get',
                singleSelect: true,
                fitColumns: true,
                onSelect: onGroupSelect,
                onDblClickRow: function(index,row){
                    $('#groupGrid').datagrid('selectRow', index);
                    editGroup();
                }
            });
        }

        function initAlertGroupDialog(){
            $('#alertMachineGroupGrid').datagrid({
                singleSelect: false,
                checkbox: true,
                fitColumns: true
            });
        }

        function onGroupSelect(index, row){
            currentGroupName = row.GroupName;
            currentRoleId = row.RoleId;
            console.log('選擇警報群組:', currentGroupName, '角色:', currentRoleId);
        }

        function openGroupDlg(){
            currentGroupName = null;
            currentRoleId = null;
            $('#formGroup').form('clear');
            $('#roleSelect').combobox('clear');
            $('#IsActive').prop('checked', true);
            $('#dlgGroup').dialog('open').dialog('setTitle','新增警報群組');
            loadMachineGroupsForAlert([]);
        }

        function editGroup(){
            const row = $('#groupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');

            currentGroupName = row.GroupName;
            currentRoleId = row.RoleId;

            // 載入基本資料
            $('#GroupName').textbox('setValue', row.GroupName);
            $('#Description').textbox('setValue', row.Description);
            $('#roleSelect').combobox('setValue', row.RoleId);
            $('#IsActive').prop('checked', !!row.IsActive);

            $('#dlgGroup').dialog('open').dialog('setTitle', '編輯警報群組');

            // 載入該警報群組的機台群組設定
            $.get('@Url.Action("GetAlertGroupDetail","AlarmManage")', {
                groupName: row.GroupName,
                roleId: row.RoleId
            }, res => {
                if(res.success && res.data){
                    loadMachineGroupsForAlert(res.data.MachineGroupIds || []);
                } else {
                    loadMachineGroupsForAlert([]);
                }
            });
        }

        function deleteGroup(){
            const row = $('#groupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');

            $.messager.confirm('確認刪除', `確定要刪除警報群組「${row.GroupName}」(${row.RoleName})嗎？`, function(confirmed) {
                if (!confirmed) return;

                $.ajax({
                    url: '@Url.Action("DeleteAlertGroups","AlarmManage")',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        GroupName: row.GroupName,
                        RoleId: row.RoleId
                    }),
                    success: function(res) {
                        if (res.success) {
                            $('#groupGrid').datagrid('reload');
                            $.messager.show({
                                title: '成功',
                                msg: res.message,
                                timeout: 3000
                            });
                        } else {
                            $.messager.alert('錯誤', res.message || '刪除失敗');
                        }
                    },
                    error: function() {
                        $.messager.alert('錯誤', '刪除時發生網路錯誤');
                    }
                });
            });
        }

        function toggleGroupActive(){
            const row = $('#groupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆警報群組');

            const newStatus = !row.IsActive;
            const statusText = newStatus ? '啟用' : '停用';

            $.messager.confirm('確認', `確定要${statusText}「${row.GroupName}」(${row.RoleName})警報群組？`, function(r){
                if(r){
                    $.ajax({
                        url: '@Url.Action("ToggleAlertGroupsActive","AlarmManage")',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            GroupName: row.GroupName,
                            RoleId: row.RoleId,
                            IsActive: newStatus
                        }),
                        success: res => {
                            if(res.success){
                                $('#groupGrid').datagrid('reload');
                                $.messager.show({
                                    title:'成功',
                                    msg: res.message
                                });
                            } else {
                                $.messager.alert('錯誤', res.message || '操作失敗');
                            }
                        }
                    });
                }
            });
        }

        function loadMachineGroupsForAlert(selectedGroupIds){
            $.get('@Url.Action("GetMachineGroups","AlarmManage")', res => {
                if(res && res.rows){
                    $('#alertMachineGroupGrid').datagrid('loadData', res.rows);

                    res.rows.forEach((r,i)=>{
                        if(selectedGroupIds.includes(r.MachineGroupId)){
                            $('#alertMachineGroupGrid').datagrid('checkRow', i);
                        }
                    });
                } else {
                    console.error('無法載入機台群組清單');
                }
            });
        }

        function saveGroup(){
            const groupName = $('#GroupName').textbox('getValue');
            const description = $('#Description').textbox('getValue');
            const roleId = $('#roleSelect').combobox('getValue');
            const selectedMachineGroups = $('#alertMachineGroupGrid').datagrid('getChecked').map(r => r.MachineGroupId);
            const isActive = $('#IsActive').is(':checked');

            if(!groupName) {
                return $.messager.alert('提示','請輸入群組名稱');
            }
            if(!roleId) {
                return $.messager.alert('提示','請選擇一個角色');
            }
            if(selectedMachineGroups.length === 0) {
                return $.messager.alert('提示','請至少選擇一個機台群組');
            }

            const data = {
                GroupName: groupName,
                Description: description,
                RoleId: parseInt(roleId),
                MachineGroupIds: selectedMachineGroups,
                IsActive: isActive
            };

            console.log('送出警報群組資料:', data);

            $.ajax({
                url: '@Url.Action("SaveAlertGroups", "AlarmManage")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: res => {
                    if(res.success){
                        $('#dlgGroup').dialog('close');
                        $('#groupGrid').datagrid('reload');
                        $.messager.show({
                            title:'成功',
                            msg: res.message
                        });
                    } else {
                        $.messager.alert('錯誤', res.message || '儲存失敗');
                    }
                }
            });
        }

        // ===== 機台群組相關功能 =====
        function initMachineGroupGrid(){
            $('#machineGroupGrid').datagrid({
                url: '@Url.Action("GetMachineGroups","AlarmManage")',
                method: 'get',
                singleSelect: true,
                fitColumns: true,
                onSelect: onMGSelect,
                onDblClickRow: function(index,row){
                    $('#machineGroupGrid').datagrid('selectRow', index);
                    editMG();
                }
            });
        }

        function initMGDialog(){
            $('#machineSelectGrid').datagrid({
                singleSelect: false,
                checkbox: true,
                fitColumns: true
            });
        }

        function onMGSelect(index, row){
            currentMGId = row.MachineGroupId;
            console.log('選擇機台群組:', currentMGId);
        }

        function openMGDlg(){
            currentMGId = null;
            $('#formMG').form('clear');
            $('#dlgMG').dialog('open').dialog('setTitle','新增機台群組');
            loadMachinesForMG([]);
        }

        function editMG(){
            const row = $('#machineGroupGrid').datagrid('getSelected');
            if(!row) return $.messager.alert('提示','請先選擇一筆');
            currentMGId = row.MachineGroupId;

            $('#formMG').form('load', row);
            $('#dlgMG').dialog('open').dialog('setTitle','編輯機台群組');

            $.get('@Url.Action("GetMachineGroupsById", "AlarmManage")', { id: currentMGId }, res => {
                if(res.success){
                    const memberIds = res.data;
                    loadMachinesForMG(memberIds);
                }
            });
        }

        function loadMachinesForMG(memberIds){
            $.get('@Url.Action("GetMachineList","MachineManage")', res => {
                const data = res.data.map(r=>({
                    DeviceId: r.DeviceID,
                    DeviceName: r.DeviceName
                }));
                $('#machineSelectGrid').datagrid('loadData', data);

                data.forEach((r,i)=>{
                    if(memberIds.includes(r.DeviceId)){
                        $('#machineSelectGrid').datagrid('checkRow', i);
                    }
                });
            });
        }

        function saveMG(){
            const name = $('#formMG input[name=GroupName]').val();
            const desc = $('#formMG input[name=Description]').val();
            const devs = $('#machineSelectGrid').datagrid('getChecked').map(r => r.DeviceId);

            if(!name) return $.messager.alert('提示','請輸入群組名稱');

            $.ajax({
                url: '@Url.Action("SaveMachineGroup", "AlarmManage")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    MachineGroupId: currentMGId || 0,
                    GroupName: name,
                    Description: desc,
                    Devices: devs
                }),
                success: res => {
                    if(res.success){
                        $('#dlgMG').dialog('close');
                        $('#machineGroupGrid').datagrid('reload');
                        // 如果警報群組對話框是開啟的，也要重新載入機台群組列表
                        if ($('#dlgGroup').dialog('options').closed === false) {
                            loadMachineGroupsForAlert([]);
                        }
                        $.messager.show({
                            title:'成功',
                            msg: res.message
                        });
                    } else {
                        $.messager.alert('錯誤', res.message || '儲存失敗');
                    }
                }
            });
        }

        function deleteMG(){
            const row = $('#machineGroupGrid').datagrid('getSelected');
            if(!row) {
                return $.messager.alert('提示','請先選擇要刪除的機台群組');
            }

            $.ajax({
                url: '@Url.Action("CheckMachineGroupCanDelete", "AlarmManage")',
                method: 'GET',
                dataType: 'json',
                data: { machineGroupId: row.MachineGroupId },
                success: function(checkResult) {
                    if (!checkResult.success) {
                        $.messager.alert('錯誤', checkResult.message || '檢查刪除條件時發生錯誤');
                        return;
                    }

                    let confirmMessage = `確定要刪除機台群組「${row.GroupName}」嗎？`;

                    if (!checkResult.canDelete) {
                        $.messager.alert('無法刪除', checkResult.reason);
                        return;
                    }

                    if (checkResult.reason && checkResult.reason !== '可以安全刪除') {
                        confirmMessage += `\n\n注意：${checkResult.reason}`;
                    }

                    $.messager.confirm('確認刪除', confirmMessage, function(confirmed) {
                        if (!confirmed) return;

                        $.ajax({
                            url: '@Url.Action("DeleteMachineGroup", "AlarmManage")',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ id: row.MachineGroupId }),
                            success: function(res) {
                                if (res.success) {
                                    $('#machineGroupGrid').datagrid('reload');
                                    // 如果警報群組對話框是開啟的，也要重新載入機台群組列表
                                    if ($('#dlgGroup').dialog('options').closed === false) {
                                        loadMachineGroupsForAlert([]);
                                    }
                                    $.messager.show({
                                        title: '成功',
                                        msg: res.message,
                                        timeout: 3000
                                    });
                                } else {
                                    $.messager.alert('錯誤', res.message || '刪除失敗');
                                }
                            },
                            error: function() {
                                $.messager.alert('錯誤', '刪除機台群組時發生錯誤');
                            }
                        });
                    });
                },
                error: function() {
                    $.messager.confirm('確認刪除', `確定要刪除機台群組「${row.GroupName}」嗎？`, function(confirmed) {
                        if (!confirmed) return;

                        $.ajax({
                            url: '@Url.Action("DeleteMachineGroup", "AlarmManage")',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ id: row.MachineGroupId }),
                            success: function(res) {
                                if (res.success) {
                                    $('#machineGroupGrid').datagrid('reload');
                                    if ($('#dlgGroup').dialog('options').closed === false) {
                                        loadMachineGroupsForAlert([]);
                                    }
                                    $.messager.show({
                                        title: '成功',
                                        msg: res.message,
                                        timeout: 3000
                                    });
                                } else {
                                    $.messager.alert('錯誤', res.message || '刪除失敗');
                                }
                            },
                            error: function() {
                                $.messager.alert('錯誤', '刪除機台群組時發生錯誤');
                            }
                        });
                    });
                }
            });
        }
    </script>
}