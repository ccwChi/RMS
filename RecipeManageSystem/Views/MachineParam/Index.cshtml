 @{
    ViewBag.Title = "機台參數對照維護";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section css{
    <link rel="stylesheet" href="@Href("~/Scripts/base/easyui/themes/bootstrap/easyui.css")" />
    <link rel="stylesheet" href="@Href("~/Scripts/base/easyui/themes/icon.css")" />
    <style>
        .param-cell {
            display: flex;
            padding-top: 10px;
            align-items: flex-start; /* 文字在上 */
            overflow-x: auto;
            height: 50px;
        }

        .easyui-datagrid .datagrid-header .datagrid-cell {

            height: 50px;
            line-height: 50px;
        }
    </style>
}

<h2>機台參數對照維護(雙擊項目開啟編輯)</h2>

<table id="mpGrid" class="easyui-datagrid" style="width:100%;">
    <thead>
        <tr>
            <th data-options="field:'Index',width:50">#</th>
            <th data-options="field:'DeviceID',width:150">機台</th>
            <th data-options="field:'ParamName'">參數</th>
        </tr>
    </thead>
</table>

<div id="toolbar" style="padding:5px 0; display:flex; align-items:center">
    <div href="javascript:void(0)" class="custom-easyui-button" onclick="openMpDialog(0)">新增</div>
</div>

<!-- 新增/編輯 Dialog -->
<div id="mpDlg" class="easyui-dialog" closed="true" style="width:80%; height:80%; overflow:auto" modal="true" buttons="#mpDlgBtns">
    <form id="mpForm" method="post">
        <input type="hidden" name="MappingId" />

        <div style="margin:8px">
            <label style="display:inline-block;width:80px">機台：</label>
            <input name="Device"
                   id="Device"
                   class="easyui-combobox"
                   style="width:300px" />
            <label style="display:inline-block;width:80px">料號：</label>
            <input name="ProdNo"
                   id="ProdNo"
                   class="easyui-textbox"
                   style="width:300px" />
        </div>

        <div id="paramList"
             style="overflow-y: auto; border: 1px solid #ddd; padding: 15px; display: flex; flex-wrap: wrap; justify-content: space-between">
        </div>

    </form>
    <div id="saveOverlay" style="
            display:none;
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background-color:rgba(255,255,255,0.7);
            z-index:9999;
            justify-content:center;
            align-items:center;
            font-size:18px;
            color:#333;
        ">
        <div><i class="fa fa-spinner fa-spin"></i> 儲存中，請稍候...</div>
    </div>
</div>
<div id="mpDlgBtns" style="text-align:center; display:flex; justify-content:end;">
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="saveMp()">儲存</a>
    <a href="javascript:void(0)" class="custom-easyui-button" onclick="$('#mpDlg').dialog('close')">取消</a>
</div>

@section Scripts {
    <script src="~/Scripts/base/easyui/jquery.easyui.min.js"></script>
    <script>
        var machineList = [];
        var paramList = []

        $(function () {
            // 1) 同步載入機台清單
            $.ajax({
                url: '@Url.Action("GetMachineList", "MachineManage")',
                method: 'GET',
                dataType: 'json',
                async: false,
                success: function (res) {
                    if (res.success) {
                        machineList = res.data; 
                        console.log(machineList)
                    } else {
                        $.messager.alert('錯誤', '無法載入機台清單');
                    }
                },
                error: function () {
                    $.messager.alert('錯誤', '無法載入機台清單');
                }
            });

            // 1) 同步載入參數清單
            $.ajax({
                url: '@Url.Action("GetParameterList", "Param")',
                method: 'GET',
                dataType: 'json',
                success: function (res) {
                    if (res.success) {
                        paramList = res.data;
                    } else {
                        $.messager.alert('錯誤', '無法載入機台參數對應清單');
                    }
                },
                error: function () {
                    $.messager.alert('錯誤', '無法載入機台參數對應清單');
                }
            });

            // 2) 重新初始化 Combobox，這次把 data 傳入
            $('#Device').combobox({
                multiple: false,
                //panelHeight: 'auto',
                valueField: 'DeviceID',
                textField: 'DeviceName',
                data: machineList
            });

            renderParamCheckboxes();  // Dialog 打開前先初始化

            $('#mpDlg').dialog({
                closed: true,
                modal: true,
                buttons: '#mpDlgBtns'
            });

            $('#mpGrid').datagrid({
                data: machineList,
                method: 'get',
                toolbar: '#toolbar',
                fitColumns: true,
                singleSelect: true,
                columns: [[
                    { field: 'DeviceID', title: '機台代號', width: 100 },
                    { field: 'DeviceName', title: '機台名稱', width: 200 }
                ]],
                onDblClickRow: function (_, row) {
                    openMpDialog(row.DeviceID);   // 只帶 DeviceID
                }
            });

        });

        function openMpDialog(deviceId) {

    $('#mpForm').form('clear');
    $('#Device')
        .combobox('loadData', machineList)
        .combobox(deviceId ? 'disable' : 'enable');

    // 1) 先確保 paramList 已經有資料，若沒有就 AJAX 取一次
    var p1 = $.Deferred();
    if (paramList.length) {
        p1.resolve();   // 已有就直接結束
    } else {
        $.getJSON('@Url.Action("GetParameterList","Param")', function (res) {
            if (!res.success) { $.messager.alert('錯誤', '無法載入參數清單'); p1.reject(); return; }
            paramList = res.data;
            p1.resolve();
        }).fail(function () { $.messager.alert('錯誤', '無法載入參數清單'); p1.reject(); });
    }

    // 2) 如果是編輯，另開 AJAX 抓該機台已選參數；若是新增，直接用空陣列
    var p2 = $.Deferred();
    if (!deviceId) {
        p2.resolve([]);            // 新增 → 沒有已選值
    } else {
        $.getJSON('@Url.Action("GetMappingByDevice","MachineParam")', { deviceId }, function (res) {
            if (!res.success) { $.messager.alert('錯誤', '讀取資料失敗'); p2.reject(); return; }
            p2.resolve(res.data.ParamIds || []);
            $('#Device').combobox('setValue', res.data.DeviceId);
        }).fail(function () { $.messager.alert('錯誤', '讀取資料失敗'); p2.reject(); });
    }

    // 3) 兩個 AJAX 都完成後再 render & 開 Dialog
    $.when(p1, p2).done(function (_, selectedIds) {   // selectedIds 是 p2 的結果
        renderParamCheckboxes(selectedIds);
        $('#mpDlg')
            .dialog({ title: deviceId ? '編輯機台參數' : '新增機台參數', closed: false, modal: true })
            .dialog('center');
    });
        }

        function renderParamCheckboxes(selectedIds = []) {
            var $c = $('#paramList').empty();
            paramList.forEach(p => {
                const chk = selectedIds.includes(p.ParamId) ? 'checked' : '';
                $c.append(
                    `<label style="display:block;margin:2px 0;">
                <input type="checkbox" name="ParamIds" value="${p.ParamId}" ${chk}> ${p.ParamName}
              </label>`
                );
            });
        }

        function saveMp() {
            var deviceId = $('#Device').combobox('getValue');
            var params = $('input[name="ParamIds"]:checked').map(function() {
                return parseInt(this.value);
            }).get();
            console.log({ deviceId })
            console.log({ params })
            $('#saveOverlay').css('display', 'flex');

              // 4. 呼叫 API
              $.ajax({
                url: '@Url.Action("SaveMapping", "MachineParam")',
                type: 'POST',
                contentType: 'application/json',
                  data: JSON.stringify({
                      DeviceId: deviceId,
                      Params: params
                  }),
                  success: function (res) {
                      $('#saveOverlay').hide();

                  if (res.success) {
                    $('#mpDlg').dialog('close');
                    $('#mpGrid').datagrid('reload');
                  } else {
                    $.messager.alert('錯誤', res.message);
                  }
                },
                  error: function () {
                      $('#saveOverlay').hide();
                  $.messager.alert('錯誤', '儲存時發生問題');
                }
              });
        }

        function renderParamCheckboxes(selectedIds = []) {
            var container = $('#paramList');
            container.empty();  // 先清空

            paramList.forEach(p => {
                const checked = selectedIds.includes(p.ParamId) ? 'checked' : '';
                container.append(`<label style="width:250px; margin:3px 0; display:inline-block;">
                                    <input type="checkbox" name="ParamIds" value="${p.ParamId}" ${checked}> ${p.ParamName}
                                  </label>`);
            });
        }

    </script>
}
